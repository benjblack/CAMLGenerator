define(["durandal/system","durandal/viewLocator","durandal/binder","durandal/viewEngine","durandal/activator","jquery","knockout"],function(e,t,i,n,a,r,o){function c(e){for(var t=[],i={childElements:t,activeView:null},n=o.virtualElements.firstChild(e);n;)1==n.nodeType&&(t.push(n),n.getAttribute(h)&&(i.activeView=n)),n=o.virtualElements.nextSibling(n);return i.activeView||(i.activeView=t[0]),i}function s(){b--,0===b&&setTimeout(function(){for(var e=w.length;e--;)w[e]();w=[]},1)}function l(t,i,n){if(n)i();else if(t.activate&&t.model&&t.model.activate){var a;a=e.isArray(t.activationData)?t.model.activate.apply(t.model,t.activationData):t.model.activate(t.activationData),a&&a.then?a.then(i):a||void 0===a?i():s()}else i()}function u(){var t=this;t.activeView&&t.activeView.removeAttribute(h),t.child&&(t.model&&t.model.attached&&(t.composingNewView||t.alwaysTriggerAttach)&&t.model.attached(t.child,t.parent,t),t.attached&&t.attached(t.child,t.parent,t),t.child.setAttribute(h,!0),t.composingNewView&&t.model&&(t.model.compositionComplete&&g.current.complete(function(){t.model.compositionComplete(t.child,t.parent,t)}),t.model.detached&&o.utils.domNodeDisposal.addDisposeCallback(t.child,function(){t.model.detached(t.child,t.parent,t)})),t.compositionComplete&&g.current.complete(function(){t.compositionComplete(t.child,t.parent,t)})),s(),t.triggerAttach=e.noop}function d(t){if(e.isString(t.transition)){if(t.activeView){if(t.activeView==t.child)return!1;if(!t.child)return!0;if(t.skipTransitionOnSameViewId){var i=t.activeView.getAttribute("data-view"),n=t.child.getAttribute("data-view");return i!=n}}return!0}return!1}function v(e){for(var t=0,i=e.length,n=[];i>t;t++){var a=e[t].cloneNode(!0);n.push(a)}return n}function f(e){var t=v(e.parts),i=g.getParts(t),n=g.getParts(e.child);for(var a in i)r(n[a]).replaceWith(i[a])}function m(t){var i,n,a=o.virtualElements.childNodes(t);if(!e.isArray(a)){var r=[];for(i=0,n=a.length;n>i;i++)r[i]=a[i];a=r}for(i=1,n=a.length;n>i;i++)o.removeNode(a[i])}var g,p={},h="data-active-view",w=[],b=0,y="durandal-composition-data",A="data-part",D="["+A+"]",S=["model","view","transition","area","strategy","activationData"],I={complete:function(e){w.push(e)}};return g={convertTransitionToModuleId:function(e){return"transitions/"+e},defaultTransitionName:null,current:I,addBindingHandler:function(e,t,i){var n,a,r="composition-handler-"+e;t=t||o.bindingHandlers[e],i=i||function(){return void 0},a=o.bindingHandlers[e]={init:function(e,n,a,c,s){var l={trigger:o.observable(null)};return g.current.complete(function(){t.init&&t.init(e,n,a,c,s),t.update&&(o.utils.domData.set(e,r,t),l.trigger("trigger"))}),o.utils.domData.set(e,r,l),i(e,n,a,c,s)},update:function(e,t,i,n,a){var c=o.utils.domData.get(e,r);return c.update?c.update(e,t,i,n,a):(c.trigger(),void 0)}};for(n in t)"init"!==n&&"update"!==n&&(a[n]=t[n])},getParts:function(t){var i={};e.isArray(t)||(t=[t]);for(var n=0;n<t.length;n++){var a=t[n];if(a.getAttribute){var o=a.getAttribute(A);o&&(i[o]=a);for(var c=r(D,a).not(r("[data-bind] "+D,a)),s=0;s<c.length;s++){var l=c.get(s);i[l.getAttribute(A)]=l}}}return i},cloneNodes:v,finalize:function(t){if(t.transition=t.transition||this.defaultTransitionName,t.child||t.activeView)if(d(t)){var n=this.convertTransitionToModuleId(t.transition);e.acquire(n).then(function(e){t.transition=e,e(t).then(function(){if(t.cacheViews){if(t.activeView){var e=i.getBindingInstruction(t.activeView);void 0==e.cacheViews||e.cacheViews||o.removeNode(t.activeView)}}else t.child?m(t.parent):o.virtualElements.emptyNode(t.parent);t.triggerAttach()})}).fail(function(t){e.error("Failed to load transition ("+n+"). Details: "+t.message)})}else{if(t.child!=t.activeView){if(t.cacheViews&&t.activeView){var a=i.getBindingInstruction(t.activeView);void 0==a.cacheViews||a.cacheViews?r(t.activeView).hide():o.removeNode(t.activeView)}t.child?(t.cacheViews||m(t.parent),r(t.child).show()):t.cacheViews||o.virtualElements.emptyNode(t.parent)}t.triggerAttach()}else t.cacheViews||o.virtualElements.emptyNode(t.parent),t.triggerAttach()},bindAndShow:function(e,t,a){t.child=e,t.composingNewView=t.cacheViews?-1==o.utils.arrayIndexOf(t.viewElements,e):!0,l(t,function(){if(t.binding&&t.binding(t.child,t.parent,t),t.preserveContext&&t.bindingContext)t.composingNewView&&(t.parts&&f(t),r(e).hide(),o.virtualElements.prepend(t.parent,e),i.bindContext(t.bindingContext,e,t.model));else if(e){var a=t.model||p,c=o.dataFor(e);if(c!=a){if(!t.composingNewView)return r(e).remove(),n.createView(e.getAttribute("data-view")).then(function(e){g.bindAndShow(e,t,!0)}),void 0;t.parts&&f(t),r(e).hide(),o.virtualElements.prepend(t.parent,e),i.bind(a,e)}}g.finalize(t)},a)},defaultStrategy:function(e){return t.locateViewForObject(e.model,e.area,e.viewElements)},getSettings:function(t){var i,r=t(),c=o.utils.unwrapObservable(r)||{},s=a.isActivator(r);if(e.isString(c))return c=n.isViewUrl(c)?{view:c}:{model:c,activate:!0};if(i=e.getModuleId(c))return c={model:c,activate:!0};!s&&c.model&&(s=a.isActivator(c.model));for(var l in c)c[l]=-1!=o.utils.arrayIndexOf(S,l)?o.utils.unwrapObservable(c[l]):c[l];return s?c.activate=!1:void 0===c.activate&&(c.activate=!0),c},executeStrategy:function(e){e.strategy(e).then(function(t){g.bindAndShow(t,e)})},inject:function(i){return i.model?i.view?(t.locateView(i.view,i.area,i.viewElements).then(function(e){g.bindAndShow(e,i)}),void 0):(i.strategy||(i.strategy=this.defaultStrategy),e.isString(i.strategy)?e.acquire(i.strategy).then(function(e){i.strategy=e,g.executeStrategy(i)}).fail(function(t){e.error("Failed to load view strategy ("+i.strategy+"). Details: "+t.message)}):this.executeStrategy(i),void 0):(this.bindAndShow(null,i),void 0)},compose:function(i,n,a,r){b++,r||(n=g.getSettings(function(){return n},i));var o=c(i);n.activeView=o.activeView,n.parent=i,n.triggerAttach=u,n.bindingContext=a,n.cacheViews&&!n.viewElements&&(n.viewElements=o.childElements),n.model?e.isString(n.model)?e.acquire(n.model).then(function(t){n.model=e.resolveObject(t),g.inject(n)}).fail(function(t){e.error("Failed to load composed module ("+n.model+"). Details: "+t.message)}):g.inject(n):n.view?(n.area=n.area||"partial",n.preserveContext=!0,t.locateView(n.view,n.area,n.viewElements).then(function(e){g.bindAndShow(e,n)})):this.bindAndShow(null,n)}},o.bindingHandlers.compose={init:function(){return{controlsDescendantBindings:!0}},update:function(e,t,i,a,r){var c=g.getSettings(t,e);if(c.mode){var s=o.utils.domData.get(e,y);if(!s){var l=o.virtualElements.childNodes(e);s={},"inline"===c.mode?s.view=n.ensureSingleElement(l):"templated"===c.mode&&(s.parts=v(l)),o.virtualElements.emptyNode(e),o.utils.domData.set(e,y,s)}"inline"===c.mode?c.view=s.view.cloneNode(!0):"templated"===c.mode&&(c.parts=s.parts),c.preserveContext=!0}g.compose(e,c,r,!0)}},o.virtualElements.allowedBindings.compose=!0,g});